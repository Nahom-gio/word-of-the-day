name: Word of the Day

on:
  schedule:
    # 06:00 Ethiopia time (Africa/Addis_Ababa) â‰ˆ 03:00 UTC
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate word + definition and write files
        shell: bash
        run: |
          set -euo pipefail
          DATE=$(date -u +"%Y-%m-%d")

          WORD=$(curl -fsSL "https://random-word-api.herokuapp.com/word?number=1" \
            | python3 -c 'import json,sys; print(json.load(sys.stdin)[0])')

          DEF_JSON=$(curl -fsSL "https://api.dictionaryapi.dev/api/v2/entries/en/${WORD}" || true)

          python3 - << PY
          import json, pathlib
          date = "${DATE}"
          word = "${WORD}"
          def_json = r'''${DEF_JSON}'''

          definition = "Definition unavailable today."
          example = ""

          try:
            data = json.loads(def_json)
            meaning = data[0]["meanings"][0]
            definition = meaning["definitions"][0].get("definition") or definition
            example = meaning["definitions"][0].get("example") or ""
          except Exception:
            pass

          out = {
            "date": date,
            "word": word,
            "definition": definition,
            "example": example,
            "source": "random-word-api + dictionaryapi.dev"
          }

          pathlib.Path("data").mkdir(parents=True, exist_ok=True)
          pathlib.Path("data/today.json").write_text(json.dumps(out, ensure_ascii=False, indent=2) + "\\n", encoding="utf-8")

          hist = pathlib.Path("data/history.jsonl")
          with hist.open("a", encoding="utf-8") as f:
            f.write(json.dumps(out, ensure_ascii=False) + "\\n")
          PY

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/today.json data/history.jsonl
          git diff --cached --quiet || git commit -m "chore: word of the day ($(date -u +"%Y-%m-%d"))"
          git push
